using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.IO;

namespace Задача_31.Brave_new_world
{
    internal class Program
    {
        static void Main(string[] args)
        {
            /*Сделать игровую карту с помощью двумерного массива. Сделать функцию рисования карты. 
             * Помимо этого, дать пользователю возможность перемещаться по карте и взаимодействовать с элементами 
             * (например пользователь не может пройти сквозь стену)
             * Все элементы являются обычными символами*/

            Console.CursorVisible = false;

            PlayingStartLevel();
            PlayingFinishLevel();

        }

        static void PlayingStartLevel()
        {
            bool isLevelFinished = false;
            bool isOpenPortal = false;
            int heroX, heroY;
            int heroDX = 0, heroDY = 0;
            char portalKey = '$';
            string levelName = "startLevel";

            char[,] map = ReadMap(levelName, out heroX, out heroY);
            DrawMap(map);            

            while (isLevelFinished == false)
            {

                if (map[heroX, heroY] == portalKey)
                {
                    isOpenPortal = true;
                }                

                if (Console.KeyAvailable)
                {
                    ConsoleKeyInfo key = Console.ReadKey(true);

                    ChangeDirection(key, ref heroDX, ref heroDY);

                    if (map[heroX + heroDX, heroY + heroDY] != '#')
                    {
                        Move(ref heroX, ref heroY, heroDX, heroDY);
                    }
                }                

                if (map[heroX, heroY] == 'O' && isOpenPortal == true)
                {                                      
                    isLevelFinished = true;
                    Console.Clear();
                    Console.SetCursorPosition(0, 1);
                    Console.WriteLine("Вы проходите на следующий уровень!\nДля перехода на новый уровень нажмите любую клавишу.");
                    Console.ReadKey();
                    Console.Clear();
                }
            }
        }

        static void PlayingFinishLevel()
        {
            bool isLevelFinished = false;
            bool isArthurSwordFound = false;
            bool isHolyGrailFound = false;
            int heroX, heroY;
            int heroDX = 0, heroDY = 0;
            string levelName = "finishLevel";
            char holyGrail = 'G';
            char kingArthurSword = 'S';

            char[,] map = ReadMap(levelName, out heroX, out heroY);
            DrawMap(map);            

            while (isLevelFinished == false)
            {

                if (map[heroX, heroY] == holyGrail)
                {
                    isHolyGrailFound = true;
                }
                else if (map[heroX, heroY] == kingArthurSword)
                {
                    isArthurSwordFound = true;
                }

                WritingMessage(isArthurSwordFound, isHolyGrailFound, heroX, heroY);

                if (Console.KeyAvailable)
                {
                    ConsoleKeyInfo key = Console.ReadKey(true);

                    ChangeDirection(key, ref heroDX, ref heroDY);
                    
                    if (map[heroX + heroDX, heroY + heroDY] != '#')
                    {
                        Move(ref heroX, ref heroY, heroDX, heroDY);
                    }
                }

                if (map[heroX, heroY] == 'O' && isHolyGrailFound == true && isArthurSwordFound == true)
                {
                    isLevelFinished = true;
                    Console.Clear();
                    Console.SetCursorPosition(0, 1);
                    Console.WriteLine("Вы прошли игру!\nДля выхода из игры нажмите любую клавишу.");
                    Console.ReadKey();
                    Console.Clear();
                }
            }
        }

        static void Move (ref int X, ref int Y, int DX, int DY)
        {
            Console.SetCursorPosition(Y, X);
            Console.Write(' ');

            X += DX;
            Y += DY;

            Console.SetCursorPosition(Y, X);
            Console.Write('*');
        }

        static void WritingMessage(bool isHolyGrailFound, bool isArthurSwordFound, int heroX, int heroY)
        {
            Console.SetCursorPosition(0, 15);
            Console.WriteLine("Для прохождения уровня нужно найти меч Короля Артура А и Святой Грааль G");

            if (isHolyGrailFound == true && isArthurSwordFound == false)
            {
                Console.WriteLine("Вы подобрали Святой Грааль.\nМеч Короля Артура не найден.\nПроход закрыт");
            }
            else if (isHolyGrailFound == false && isArthurSwordFound == true)
            {
                Console.WriteLine("Святой Грааль не найден.\nВы подобрали Меч Короля Артура.\nПроход закрыт");
            }
            else if (isHolyGrailFound == true && isArthurSwordFound == true)
            {
                Console.WriteLine("Вы подобрали Святой Грааль.\nВы подобрали Меч Короля Артура.\nПроход открыт. Поспешите к порталу");
            }
            else
            {
                Console.WriteLine("Святой Грааль не найден.\nМеч Короля Артура не найден.\nПроход закрыт");
            }

            Console.SetCursorPosition(heroY, heroX);
        }

        static void WritingMessage(bool isOpenPortal, int heroX, int heroY)
        {
            Console.SetCursorPosition(0, 15);
            Console.WriteLine("Для прохода через портал, нужно найти портальный ключ $");

            if (isOpenPortal == true)
            {
                Console.WriteLine("Портал открылся");
            }
            else
            {
                Console.WriteLine("Портал закрыт");
            }

            Console.SetCursorPosition(heroY, heroX);
        }

        static void ChangeDirection (ConsoleKeyInfo key, ref int DX, ref int DY)
        {
            switch (key.Key)
            {
                case ConsoleKey.UpArrow:
                    DX = -1; DY = 0;
                    break;
                case ConsoleKey.DownArrow:
                    DX = 1; DY = 0;
                    break;
                case ConsoleKey.LeftArrow:
                    DX = 0; DY = -1;
                    break;
                case ConsoleKey.RightArrow:
                    DX = 0; DY = 1;
                    break;
            }
        }

        static char[,] ReadMap(string mapName, out int heroX, out int heroY)
        {
            heroX = 0;
            heroY = 0;
            string[] newMap = File.ReadAllLines($"maps/{mapName}.txt");
            char[,] map = new char[newMap.Length, newMap[0].Length];

            for (int i = 0; i < map.GetLength(0); i++)
            {
                for (int j = 0; j < map.GetLength(1); j++)
                {
                    map[i, j] = newMap[i][j];

                    if (map[i, j] == '*')
                    {
                        heroX = i;
                        heroY = j;
                    }
                }                
            }

            return map;
        }

        static void DrawMap (char[,] map)
        {
            for (int i = 0; i < map.GetLength(0); i++)
            {
                for (int j = 0; j < map.GetLength(1); j++)
                {
                    Console.Write(map[i, j]);
                }

                Console.WriteLine("");
            }
        }
    }
}
